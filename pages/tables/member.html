<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>会员基本信息管理</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <!-- Bootstrap 3.3.6 -->
  <link rel="stylesheet" href="../../bootstrap/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="../../plugins/datatables/dataTables.bootstrap.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../dist/css/AdminLTE.min.css">
  <link rel="stylesheet" href="../../dist/css/bootstrap-switch.min.css">
  <!-- AdminLTE Skins. Choose a skin from the css/skins
       folder instead of downloading all of them to reduce the load. -->
  <link rel="stylesheet" href="../../dist/css/skins/_all-skins.min.css">
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">

  <header class="main-header">
    <!-- Logo -->
    <a href="../../index3.html" class="logo">
      <!-- mini logo for sidebar mini 50x50 pixels -->
      <span class="logo-mini"><b>R</b>HM</span>
      <!-- logo for regular state and mobile devices -->
      <span class="logo-lg"><b>润合美</b>村淘合伙人</span>
    </a>
    <!-- Header Navbar: style can be found in header.less -->
    <nav class="navbar navbar-static-top">
      <!-- Sidebar toggle button-->
      <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <div class="navbar-custom-menu">
      <ul class="nav navbar-nav">
       		<li><a href="javascript:void(0);" id="logout1" >退出</a></li>
       	</ul>
        <ul class="nav navbar-nav">
          <!-- Messages: style can be found in dropdown.less-->
          
          <!-- Notifications: style can be found in dropdown.less -->
          
          <!-- Tasks: style can be found in dropdown.less -->
          
          <!-- User Account: style can be found in dropdown.less -->
          
          <!-- Control Sidebar Toggle Button -->
          <li>
            <!-- <a href="#" data-toggle="control-sidebar"><i class="fa fa-gears"></i></a> -->
          </li>
        </ul>
      </div>
    </nav>
  </header>
  <aside class="main-sidebar">
    <section class="sidebar"  id="menu_content">
     
    </section>
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1>会员管理<small>会员基本信息</small></h1>
      <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> 首页</a></li>
        <li><a href="#">会员管理</a></li>
        <li class="active">会员基本信息</li>
      </ol>
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="row">
        <div class="col-xs-12">

          <div class="box">
            <!-- <div class="box-header">
              <h3 class="box-title">Data Table With Full Features</h3>
            </div> -->
            <!-- /.box-header -->
            <div class="box-body">
            	<div class="row-fluid"  id="div-advanced-search">
                    <form class="form-inline well"  role="form" id="form">
						<div class="form-group" style="margin-right: 7px">
						    <label class="" for="villageCode-search">村点编号:</label>
						    <input type="text" class="form-control" id="villageCode-search" placeholder="村点编号">
						</div>
						<div class="form-group" style="margin-right: 7px">
						    <label class="" for="phonenumber-search">手机&#12288;号:</label>
						    <input type="text" class="form-control" id="phonenumber-search" placeholder="手机号">
						</div>
						<div class="form-group" style="margin-right: 7px">
						    <label class="" for="taobaocode-search">旺旺&#12288;号:</label>
						    <input type="text" class="form-control" id="taobaocode-search" placeholder="旺旺号">
						</div>
						<div class="form-group" style="margin-right: 7px">
						    <label class="" for="id-search">&#12288;&#12288;&#12288; ID:</label>
						    <input type="number" class="form-control" id="id-search" placeholder="ID">
						</div>
						<br/><br/>
						<div class="form-group" style="margin-right: 7px">
						    <label class="" for="name-search">姓&#12288;&#12288;名:</label>
						    <input type="text" class="form-control" id="name-search" placeholder="姓名">
						</div>
						<div class="form-group" style="margin-right: 7px">
						    <label class="" for="address-search">收货地址:</label>
						    <input type="text" class="form-control" id="address-search" placeholder="收货地址">
						</div>
						<div class="form-group" style="margin-right: 7px">
						    <label class="" for="groupstatus-search">是否进群:</label>
							<select class="input-small" id="groupstatus-search" style="width:159px;height:34px;border:1px solid #d2d6de;">
								  <option value ="">全部</option>
								  <option value ="1">是</option>
								  <option value="0">否</option>
							</select>
						</div>
						<div class="form-group" style="margin-right:7px;" >
						    <label class="" for="status-search">关联微信:</label>
							<select class="input-small" id="status-search" style="width:159px;height:34px;border:1px solid #d2d6de;">
								  <option value ="">全部</option>
								  <option value ="1">已关联</option>
								  <option value="0">未关联</option>
								  <option value="-1">被手动禁用</option>
							</select>
						</div>
						<div class="form-group" style="margin-right: 7px">
							<button type="button" class="btn" id="btn-advanced-search"><i class="fa fa-search"></i> 查询</button>
						</div>
                    </form>
<button id="weixinTag" type="button" class="btn btn-info btn-sm">设置新用户公众号标签</button>&nbsp
<button id="checkWxUserTag" type="button" class="btn btn-info btn-sm">检查并设置所有用户公众号标签</button>（15天一次）&nbsp，
向查询结果中的全部用户：<button id="sendTemplateMessage" type="button" class="btn btn-info btn-sm">发送短信</button>&nbsp
<br>
                </div>
              <table id="example" class="table table-striped table-bordered">
			        <thead>
			        <tr>
			        	<!-- <th></th> -->
			            <th>ID</th>
			            <th>姓名</th>
			            <th>村点编号</th>
			            <th>手机号</th>
			            <th>旺旺号</th>
			            <th>常用收货地址</th>
			            <th>是否进群</th>
			            <th>系统内状态</th>
			            <!-- <th>推荐禁用状态</th> -->
			            <th>最早下单时间</th>
			            <th>最后下单时间</th>
			            <th>操作</th>
			        </tr>
			        </thead>
			        <tbody></tbody>
			        <!-- tbody是必须的 -->
			    </table>
            </div>
            <!-- /.box-body -->
          </div>
          <!-- /.box -->
        </div>
        <!-- /.col -->
      </div>
      <!-- /.row -->
    </section>
    <!-- /.content -->
  </div>
  
  <!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">新增</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                	<input type="hidden" class="form-control" id="id" >
                    <input type="text" class="form-control" id="name" placeholder="姓名">
                </div>
                <div class="form-group">
                    <input type="text" class="form-control" id="taobaocode" placeholder="旺旺号">
                </div>
                <div class="form-group">
                    <input type="text" class="form-control" id="villageCode" placeholder="村点编号">
                </div>
                <div class="form-group">
                    <input type="text" class="form-control" id="phonenumber" placeholder="手机号">
                </div>
                <div class="form-group">
                    <input type="text" class="form-control" id="address" placeholder="收货地址"
                           data-date-format="yyyy/mm/dd">
                </div>
                <div class="form-group">
                    <label class="" for="groupstatus">是否进群:</label>
					<select id="groupstatus">
						<option value="1">是</option>
						<option value="0">否</option>
					</select>
                </div>
                <div class="form-group" style="display: none;">
                    <label class="" for="status">是否关联微信:</label>
                    <select id="status">
						<option value="1">是</option>
						<option value="0">否</option>
					</select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="save">保存</button>
            </div>
        </div>
    </div>
</div>

  <!-- Modal -->
<div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModal2Label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModal2Label">导入会员基本信息</h4>
            </div>
            <div class="modal-body">
            	 <br>
                <div class="form-group">
                	<a href="../../template/template.xls"  class="btn btn-primary">下载模板</a>
                </div>
                <br>
                <div class="form-group">
                    <input type="file" class="form-control" name="file" id="file-import" placeholder=""  accept=".xls,.xlsx">
                </div>
                <br><br>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <!-- <button type="button" class="btn btn-primary" id="import">保存</button> -->
            </div>
        </div>
    </div>
</div>

  <!-- Modal -->
<div class="modal fade" id="myModal3" tabindex="-1" role="dialog" aria-labelledby="myModal3Label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModal3Label">合并账户</h4>
            </div>
            <div class="modal-body" id="merge-div">
	               
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="savemerge">保存</button>
            </div>
        </div>
    </div>
</div>

  <!-- Modal -->
<div class="modal fade" id="myModal4" tabindex="-1" role="dialog" aria-labelledby="myModal4Label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span   aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModal4Label">发送短信</h4>
            </div>
            <div class="modal-body">
            	<div class="form-group">
            		<textarea rows="5"  style="width: 100%" placeholder="短信内容" id="message-content"></textarea>
            	</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="savesend">保存</button>
            </div>
        </div>
    </div>
</div>
  
  
  <!-- /.content-wrapper -->
  <footer class="main-footer">
    <div class="pull-right hidden-xs">
      <b>Version</b> 0.0.1
    </div>
    <strong>Copyright &copy; 2016-2019 <a href="#">润合美</a>.</strong> All rights reserved.
  </footer>

  <!-- /.control-sidebar -->
  <!-- Add the sidebar's background. This div must be placed
       immediately after the control sidebar -->
  <div class="control-sidebar-bg"></div>
</div>
<!-- ./wrapper -->

<!-- jQuery 2.2.3 -->
<script src="../../plugins/jQuery/jquery-2.2.3.min.js"></script>
<!-- Bootstrap 3.3.6 -->
<script src="../../bootstrap/js/bootstrap.min.js"></script>
<!-- DataTables -->
<script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
<script src="../../plugins/datatables/dataTables.bootstrap.min.js"></script>
<!-- SlimScroll -->
<script src="../../plugins/slimScroll/jquery.slimscroll.min.js"></script>
<!-- FastClick -->
<script src="../../plugins/fastclick/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="../../dist/js/app.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="../../dist/js/demo.js"></script>
<script src="../../dist/js/bootstrap-switch.min.js"></script>
<script src="../../plugins/handlebars-v3.0.1.js"></script>
<script type="text/javascript" src="../../../js/ajaxfileupload.js"></script>
<script src="../../dist/js/common.js"></script>
<script src="../../dist/js/menu.js"></script>
<script type="text/javascript">
var pagename= "member";
</script>
<!-- page script -->
<!--定义操作列按钮模板-->
<script id="tpl" type="text/x-handlebars-template">
    {{#each func}}
    <button type="button" class="btn btn-{{this.type}} btn-sm" onclick="{{this.fn}}">{{this.name}}</button>
    {{/each}}
</script>

<script id="form_div" type="text/x-handlebars-template">
	<form class="form-inline" role="form" name="merge-form-old" id="merge-form-old">

	{{#each data}}
	<div>
 	<div class="form-group">
		<input type="text" class="form-control" name="villageCode-merge" value="{{this.villageCode}}" placeholder="村点编号" readonly="true">
	</div>
	<div class="form-group">
		<input  type="text" class="form-control" name="phonenumber-merge" value="{{this.phonenumber}}" placeholder="手机号" readonly="true">
	</div>
	<div class="form-group">
		<button type="button" data-id="{{this.id}}" class="btn btn-default" onclick="removeCompletLine(this)">删除</button>
	</div>
	<div class="form-group">
		<span>购物金额：{{this.sumprice}}<span>
	</div>
	<br><br>
	</div>
	{{/each}}

 </form>

 <form class="form-inline" role="form" name="merge-form-new" id="merge-form-new">
	<button type="button" id="addFormLineBtn" class="btn btn-default" onclick="addFormLine()">添加</button>               
 </form>
</script>
<script type="text/javascript">

</script>
<script>
    var table;
    var editFlag = false;
    var tpl_form = null;
    var template_form = null;
    var removeArray =[];
    var mergeUserBaseInfoId = null;
    $(function () {
        //$('#start_date').datetimepicker();
    	
        var tpl = $("#tpl").html();
        //预编译模板
        var template = Handlebars.compile(tpl);
        
         tpl_form = $("#form_div").html();
    	 template_form = Handlebars.compile(tpl_form);

        table = $('#example').DataTable({
            ajax: {
                url: context_path+"admin/membermanage/memberlist",
                type: "POST",
                data: function(d){
                	  d.name = $('#name-search').val()
                	  d.taobaocode = $('#taobaocode-search').val()
                	  d.phonenumber = $('#phonenumber-search').val()
                	  d.address = $('#address-search').val()
                	  d.groupstatus = $('#groupstatus-search').val()
                	  d.status = $('#status-search').val()
                	  d.villageCode = $('#villageCode-search ').val()
                	  d.id=$("#id-search").val();
                }
            },
            serverSide: true,
            searching: false ,   //禁用原生搜索
            order: [],          //取消默认排序查询,否则复选框一列会出现小箭头
            "autoWidth": false,
            columns: [
				/*{ //复选框单元格
				    className: "td-checkbox",
				    orderable: false,
				    width: "30px",
				    data: null,
				    render: function (data, type, row, meta) {
				        return '<input type="checkbox" value='+row.id+' class="iCheck">';
				    }
				},*/
                {"data": "id",orderable: false},
                {"data": "name",orderable: false},
                {"data": "villageCode",orderable: false},
                {"data": "phonenumber",width:"45px",orderable: false},
                {"data": "taobaocode",orderable: false},
                {"data": "address",orderable: false,width:"200px"},
                {"data": "groupStatusStr",width:"70px",orderable: false},
                {"data": "statusStr",width:"70px",orderable: false},
                //{"data": "autoForbidStatusStr",width:"50px",orderable: false,render:function(data, type, row, meta){
                //	return data;
                //}},
                {"data": "startTime",width:"50px",orderable: false,render:function(data, type, row, meta){ 
                	if(!data){
                		return "";
                	}
                	var dt = new Date(data);
                	var date = [
                	            [dt.getFullYear(), dt.getMonth() + 1, dt.getDate()].join('-'),
                	            [dt.getHours(), dt.getMinutes(), dt.getSeconds()].join(':')
                	          ].join(' ').replace(/(?=\b\d\b)/g, '0'); // 正则补零 (略微改动)
                	return date}},
               	{"data": "endTime",width:"50px",orderable: false,render:function(data, type, row, meta){ 
               		if(!data){
                		return "";
                	}
                   	var dt = new Date(data);
                   	var date = [
                   	            [dt.getFullYear(), dt.getMonth() + 1, dt.getDate()].join('-'),
                   	            [dt.getHours(), dt.getMinutes(), dt.getSeconds()].join(':')
                   	          ].join(' ').replace(/(?=\b\d\b)/g, '0'); // 正则补零 (略微改动)
                   	return date}}
            ],
            columnDefs: [
                {
                    targets: 10,
                    render: function (a, b, c, d) {//data, type, row, meta
                    	if(c.status == "-1"){
                    		var context =
                            {
                                func: [
                                    {"name": "修改", "fn": "edit(\'"+ c.id + "\',\'"  + c.name + "\',\'" + c.taobaocode + "\',\'" + c.phonenumber + "\',\'" + c.address + "\',\'" + c.groupstatus + "\',\'" + c.status + "\',\'"+ c.villageCode+"\')", "type": "primary"}
                                    ,
                                    {"name": "启用", "fn": "switchStatus(\'" + c.id + "\')", "type": "info"}
                                ]
                            };
                    	}else{
                    		var context =
                            {
                                func: [
                                    {"name": "修改", "fn": "edit(\'"+ c.id + "\',\'"  + c.name + "\',\'" + c.taobaocode + "\',\'" + c.phonenumber + "\',\'" + c.address + "\',\'" + c.groupstatus + "\',\'" + c.status+ "\',\'"+ c.villageCode + "\')", "type": "primary"}
                                    ,
                                    {"name": "禁用", "fn": "switchStatus(\'" + c.id + "\')", "type": "danger"}
                                    ,
                                    {"name": "合并用户", "fn": "merge(\'" + c.id + "\')", "type": "success"}
                                ]
                            };
                    	}
                        var html = template(context);
                        return html;
                    }
                }

            ],
            "language": {
                "lengthMenu": "每页 _MENU_ 条记录",
                "zeroRecords": "没有找到记录",
                "info": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
                "infoEmpty": "无记录",
                "sSearch":  "<b>模糊搜索</b>：",
                "infoFiltered": "(从 _MAX_ 条记录过滤)",
                "paginate": {
                    "previous": "上一页",
                    "next": "下一页"
                },
           		"sEmptyTable":     "没有找到记录",
            	"sLoadingRecords": "载入中..."
            },
            "dom": "<'row'<'col-xs-2'l><'#mytool.col-xs-8'><'col-xs-2'f>r>" + "t" +"<'row'<'col-xs-6'i><'col-xs-6'p>>",
            initComplete: function () {
                $("#mytool").append('<button type="button" id="addButton" class="btn btn-primary btn-sm" style="margin-right:10px" data-toggle="modal" data-target="#myModal">添加</button>');
                
                //$("#mytool").append('<button id="datainit" type="button" class="btn btn-info btn-sm">导入会员基本信息</button>&nbsp');
                
                //$("#mytool").append('<button id="weixinTag" type="button" class="btn btn-info btn-sm">设置新用户公众号标签</button>&nbsp');
                //$("#mytool").append('<button id="checkWxUserTag" type="button" class="btn btn-info btn-sm">检查所有用户公众号标签（15天一次）</button>&nbsp');
                //$("#mytool").append('<button id="sendTemplateMessage" type="button" class="btn btn-info btn-sm">向查询结果中的全部用户发送短信</button>&nbsp');
                //$("#mytool").append('<button id="validAllUserBaseInfo" type="button" class="btn btn-info btn-sm">自动禁用</button>&nbsp');
               // $("#validAllUserBaseInfo").on("click", function(){
               // 	$.ajax({
                //		
               // 	});
               // });
                
                
                $("#sendTemplateMessage").click(function(){
                	$("#message-content").val('');
                	$("#myModal4").modal("show");
                });
                $("#savesend").click(function(){
                	savesend();
                })
                $("#datainit").on("click", importData);
                
                
                
                
                $("#addButton").click(function(){
                	editFlag=false;
                	$("#myModalLabel").html("新增");
                	$("#id").val("");
                	$("#name").val("");
                    $("#taobaocode").val("");
                    $("#phonenumber").val("");
                    $("#address").val("");
                    $("#groupstatus").val("0");
                    $("#status").val("0");
                    $("#villageCode").val("");
                    
                    $("#villageCode").removeAttr("disabled");
                    //$("#taobaocode").removeAttr("disabled");
                    $("#phonenumber").removeAttr("disabled");
                    
                });
                $("#weixinTag").on("click", doWeixinTag);
                $("#checkWxUserTag").on("click", checkWxUserTag);
            }
        });
        $("#save").click(add);
        $("#btn-advanced-search").click(function(){
        	table.ajax.reload();
        })
        $("#savemerge").click(function(){
        	/*var obj = $("#merge-form-old").serializeArray();
        	var formobjArray = [];
        	console.log(obj);
        	var formobj = {};
        	$.each(obj,function(i,value){
        		if(i%2 > 0){
        			formobj.phonenumber=value.value;
        			formobjArray.push(formobj);
        			formobj = {};
        		}else{
        			formobj.villagecode=value.value;
        		}
        	})
        	console.log(formobjArray);*/

        	var new_obj=$("#merge-form-new").serializeArray();
        	console.log(new_obj);
        	var new_formobjArray = [];
        	var new_formobj = {};
        	$.each(new_obj,function(i,value){
        		if(i%2 > 0){
        			new_formobj.phonenumber=value.value;
        			new_formobjArray.push(new_formobj);
        			new_formobj = {};
        		}else{
        			new_formobj.villageCode=value.value;
        		}
        	})
			console.log(new_formobjArray);
        	
        	console.log(removeArray);
        	//var remove
        	$.ajax({
        		url : context_path + 'admin/membermanage/saveUserMergeInfo',
    			type : "POST",
    			data : {removeArray:JSON.stringify(removeArray),newArray:JSON.stringify(new_formobjArray),userBaseInfoId:mergeUserBaseInfoId},
    			dataType:"JSON",
    			success : function(data, status) {
    				if(data.status=="success"){
    					alert("操作成功");
    					$("#myModal3").modal("hide");
       					table.ajax.reload(null,false)
    				}else{
    					alert("操作出现问题:"+data.message);
    				}
    			},
    			error : function(data, status, e) {
    				alert("操作异常");
    				console.log(data);
    				console.log(status);
    				console.log(e);
    			}
        	})
        })
        
       	$("#file-import").change(function(){
           	console.log(1);
           	if($("#file-import").val() != ""){
       			$.ajaxFileUpload({
       				url :context_path+'admin/membermanage/importuserbaseInfo',
       				secureuri : false,
       				type:"POST",
       				data: {fileName:encodeURI($("#file-import").val())}, 
       				fileElementId : 'file-import',
       				dataType : 'json',
       				success : function(data, status) {
       					console.log("data:"+data);
       					//imgurlnew=data.data;
       					alert("上传成功");
       					//$("#file-import").val("");
       					$("#myModal2").modal("hide");
       					table.ajax.reload(null,false)
       				},
       				error : function(data, status, e) {
       					alert("上传异常");
       				}
       			});
       		}
        })
    });
    
    /** 对所有未分组对用户，将其分到微信公众号标签：村淘 */
    function doWeixinTag(){
		$.ajax({
			url : context_path + 'admin/membermanage/updateWxUserGroup',
			type : "POST",
			data : {},
			dataType:"JSON",
			success : function(data, status) {
				alert("操作完成，已更新 "+data.data+" 人的标签");
				//table.ajax.reload(null, false);
			},
			error : function(data, status, e) {
				alert("操作异常");
				//table.ajax.reload(null, false);
			}
		})
    }
    function checkWxUserTag(){
    	if(!confirm('确认要检查所有用户吗？'))
    		return;
		$.ajax({
			url : context_path + 'admin/membermanage/checkWxUserTag',
			type : "POST",
			data : {},
			dataType:"JSON",
			success : function(data, status) {
				alert("操作完成，已更新 "+data.data+" 人的标签");
				//table.ajax.reload(null, false);
			},
			error : function(data, status, e) {
				alert("操作异常");
				//table.ajax.reload(null, false);
			}
		})
    }
    function importData(){
    	$("#myModal2").modal("show");
    }
    
    function savesend(){
    	var content =  $("#message-content").val();
    	if(content!=null && $.trim(content)!=""){
    		var flag = confirm("确定要群发短信吗?");
    		if(flag){
    			var param ={};
            	param.name = $('#name-search').val()
          	    param.taobaocode = $('#taobaocode-search').val()
          	    param.phonenumber = $('#phonenumber-search').val()
          	    param.address = $('#address-search').val()
          	    param.groupstatus = $('#groupstatus-search').val()
          	    param.status = $('#status-search').val()
          	    param.villageCode = $('#villageCode-search ').val()
          	    param.id=$("#id-search").val();
            	param.content=$("#message-content").val();
            	
            	$.ajax({
        			url : context_path + 'admin/membermanage/sendmessage',
        			type : "POST",
        			data : param,
        			dataType:"JSON",
        			success : function(data, status) {
        				alert("操作成功");
        				$("#myModal4").modal("hide");
        				table.ajax.reload(null, false);
        			},
        			error : function(data, status, e) {
        				alert("操作异常");
        				table.ajax.reload(null, false);
        			}
        		})
            	
            	
            	
            	
            	
    		}else{
    			return;
    		}
    	}else{
    		alert("短信内容不能为空");
    	}
    }

    /**
     * 清除
     */
    function clear() {
        $("#name").val("").attr("disabled",false);
        $("#position").val("");
        $("#salary").val("");
        $("#start_date").val("");
        $("#office").val("");
        $("#extn").val("");
        editFlag = false;
    }

    /**
     * 添加数据
     **/
    function add() {
    	//editFlag = false;
    	/*if(!$("#name").val()){
    		alert("姓名不能为空");
    		return false;
    	}*/
    	if(!$("#taobaocode").val()){
    		alert("旺旺号不能为空");
    		return false;
    	}
		if(!$("#phonenumber").val()){
			alert("手机号不能为空");
			return false;
    	}
		/*if(!$("#address").val()){
			alert("地址不能为空");
			return false;
    	}*/
        var addJson = {
        	"id":$("#id").val(),
            "name": $("#name").val(),
            "taobaocode": $("#taobaocode").val(),
            "phonenumber": $("#phonenumber").val(),
            "address": $("#address").val(),
            "groupstatus": $("#groupstatus").val(),
            "status": $("#status").val(),
            "villageCode":$("#villageCode").val()
        };
        ajax(addJson);
    }

	function switchStatus(id) {
		$.ajax({
			url : context_path + 'admin/membermanage/switchStatus',
			type : "POST",
			data : {id:id},
			dataType:"JSON",
			success : function(data, status) {
				//alert("操作成功");
				table.ajax.reload(null, false);
			},
			error : function(data, status, e) {
				alert("操作异常");
				table.ajax.reload(null, false);
			}
		})
	}

    //TODO 
    function merge(id){
    	console.log(id);
    	mergeUserBaseInfoId =id;
    	removeArray =[];
    	$("#merge-div").html('');
    	$.ajax({
    		url:context_path+'admin/membermanage/userMergeInfoList',
    		type:"POST",
    		dataType:"JSON",
    		data:{userbaseinfoid:id},
    		success:function(data){
    			var html_form = template_form(data);
    			$("#merge-div").html(html_form);
    			$("#myModal3").modal('show');
    		}
    	});
    }
    
    function addFormLine(){
    	$("#addFormLineBtn").before('<div>'+
    	'<div class="form-group"><input type="text" class="form-control" name="villageCode-merge" autocomplete="off"  placeholder="村点编号"></div>'+
		'<div class="form-group"><input  type="text" class="form-control" name="phonenumber-merge" autocomplete="off"  placeholder="手机号"></div>'+
		'<div class="form-group"><button type="button" class="btn btn-default" onclick="removeSimpleLine(this)">删除</button></div>'+
		'<br><br>'+
		'</div>');
    }
    function removeSimpleLine(element){
    	$(element).parent().parent().remove();
    }
    
    
    
    function removeCompletLine(element){
    	var mergeinfoid = $(element).attr('data-id');
    	removeArray.push(mergeinfoid);
    	$(element).parent().parent().remove();
    	console.log(removeArray);
    }

	/**
	 *编辑方法
	 **/
	function edit(id, name, taobaocode, phonenumber, address, groupstatus,
			status,villageCode) {
		//console.log(name);
		editFlag = true;
		$("#myModalLabel").text("修改");
		$("#id").val(id);
		$("#name").val(name);//.attr("disabled",true);
		$("#taobaocode").val(taobaocode);
		$("#phonenumber").val(phonenumber);
		$("#address").val(address);
		$("#groupstatus").val(groupstatus);
		$("#status").val(status);
		$("#villageCode").val(villageCode)
		$("#villageCode").attr("disabled", "disabled");
		//$("#taobaocode").attr("disabled", "disabled");
		$("#phonenumber").attr("disabled", "disabled");

		$("#myModal").modal("show");
	}

	function ajax(obj) {
		var url = context_path + "admin/membermanage/createmember";
		if (editFlag) {
			url = context_path + "admin/membermanage/updatemember";
		}
		$.ajax({
			url : url,
			type : "POST",
			data : {
				"id" : obj.id,
				"name" : obj.name,
				"taobaocode" : obj.taobaocode,
				"phonenumber" : obj.phonenumber,
				"address" : obj.address,
				"groupstatus" : obj.groupstatus,
				"status" : obj.status,
				"villageCode": obj.villageCode
			},
			success : function(data) {
				data = $.parseJSON(data);
				console.log(typeof data);
				if (data.status == "success") {
					table.ajax.reload(null, false);
					$("#myModal").modal("hide");
					$("#myModalLabel").text("新增");
					clear();
					console.log("结果" + data);
				} else {
					alert(data.message);
				}
			}
		});
	}
	/**
	 * 删除数据
	 * @param name
	 */
	function del(id) {
		$.ajax({
			url : context_path + "admin/membermanage/deletemamber",
			data : {
				"id" : id
			},
			success : function(data) {
				table.ajax.reload();
				console.log("删除成功" + data);
			}
		});
	}
</script>
</body>
</html>




