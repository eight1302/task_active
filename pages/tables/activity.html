<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>活动管理</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <!-- Bootstrap 3.3.6 -->
  <link rel="stylesheet" href="../../bootstrap/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="../../plugins/datatables/dataTables.bootstrap.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../dist/css/AdminLTE.min.css">
  <link rel="stylesheet" href="../../dist/css/bootstrap-switch.min.css">
  <!-- AdminLTE Skins. Choose a skin from the css/skins
       folder instead of downloading all of them to reduce the load. -->
  <link rel="stylesheet" href="../../dist/css/skins/_all-skins.min.css">
  <style>
  	p img{max-width:570px;}
  </style>
  <script type="text/javascript" src="../../../plugins/kindeditor/kindeditor.js"></script>
  <script charset="utf-8" src="../../../plugins/kindeditor/lang/zh_CN.js"></script>
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">

  <header class="main-header">
    <!-- Logo -->
    <a href="../../index3.html" class="logo">
      <!-- mini logo for sidebar mini 50x50 pixels -->
      <span class="logo-mini"><b>R</b>HM</span>
      <!-- logo for regular state and mobile devices -->
      <span class="logo-lg"><b>润合美</b>村淘合伙人</span>
    </a>
    <!-- Header Navbar: style can be found in header.less -->
    <nav class="navbar navbar-static-top">
      <!-- Sidebar toggle button-->
      <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <div class="navbar-custom-menu">
      <ul class="nav navbar-nav">
       		<li><a href="javascript:void(0);" id="logout1" >退出</a></li>
       	</ul>
        <ul class="nav navbar-nav">
          <!-- Messages: style can be found in dropdown.less-->
          
          <!-- Notifications: style can be found in dropdown.less -->
          
          <!-- Tasks: style can be found in dropdown.less -->
          
          <!-- User Account: style can be found in dropdown.less -->
          
          <!-- Control Sidebar Toggle Button -->
          <li>
            <!-- <a href="#" data-toggle="control-sidebar"><i class="fa fa-gears"></i></a> -->
          </li>
        </ul>
      </div>
    </nav>
  </header>
  <!-- Left side column. contains the logo and sidebar -->
  <aside class="main-sidebar">
    <section class="sidebar" id="menu_content">
      
    </section>
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1>活动管理<small>最新活动</small></h1>
      <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> 首页</a></li>
        <li><a href="#">活动管理</a></li>
        <li class="active">最新活动</li>
      </ol>
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="row">
        <div class="col-xs-12">

          <div class="box">
            <!-- <div class="box-header">
              <h3 class="box-title">Data Table With Full Features</h3>
            </div> -->
            <!-- /.box-header -->
            <div class="box-body">
            	<div class="row-fluid"  id="div-advanced-search">
                    <form class="form-inline well"  role="form">
						
						<div class="form-group" style="margin-right: 10px">
						    <label class="" for="content-search">活动内容:</label>
						    <input type="text" class="form-control" id="content-search" placeholder="活动内容">
						</div>
						<div class="form-group" style="margin-right: 10px">
						    <label class="" for="createdtime-search">添加日期:</label>
						    <input type="date" class="form-control" id="createdtime-search" placeholder="创建日期">
						</div>
						<div class="form-group" style="margin-right: 10px">
						    <label class="" for="endtime-search">活动结束日期:</label>
						    <input type="date" class="form-control" id="endtime-search" placeholder="结束日期">
						</div>
						<div class="form-group" style="margin-right: 10px">
						    <label class="" for="status-search">发布状态:</label>
							<select class="input-small" id="status-search" style="width:159px;height:34px;border:1px solid #d2d6de;">
								  <option value ="">全部</option>
								  <option value="0">未发布</option>
								  <option value ="1">已发布</option>
							</select>
						</div>
						<div class="form-group" style="margin-right: 10px">
							<button type="button" class="btn" id="btn-advanced-search"><i class="fa fa-search"></i> 查询</button>
						</div>
                    </form>
                </div>
              <table id="example" class="table table-striped table-bordered">
			        <thead>
			        <tr>
			        	<th></th>
			        	<th>ID</th>
			            <th>活动标题</th>
			            <th>活动图片</th>
			            <!-- <th>活动简介</th> -->
			            <th>活动添加时间</th>
			            <th>活动结束时间</th>
			            <th>状态</th>
			            <th>操作</th>
			        </tr>
			        </thead>
			        <tbody></tbody>
			        <!-- tbody是必须的 -->
			    </table>
            </div>
            <!-- /.box-body -->
          </div>
          <!-- /.box -->
        </div>
        <!-- /.col -->
      </div>
      <!-- /.row -->
    </section>
    <!-- /.content -->
  </div>
  
  <!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" >
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel"><b>活动详情</b></h4>
            </div>
            <div class="modal-body">
            	<div class="form-group">
	                <p id="detail-title" ></p>
                </div>
                <div class="form-group">
	                <p id="detail-summary"></p>
                </div>
                <div class="form-group">
	                <p id="detail-headerimg"></p>
                </div>
                <div class="form-group">
	                <p id="detail-endtime" >活动结束日期:</p>
                </div>
                <div class="form-group">
	                <p ><b>活动内容：</b></p>
	                <p id="detail-content" ></p>
                </div>
                <br>
            </div>
            <div class="modal-footer">
                <!-- <button type="button" class="btn btn-info" id="initData">添加模拟数据</button> -->
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <!-- <button type="button" class="btn btn-primary" id="save">保存</button> -->
            </div>
        </div>
    </div>
</div>
  
<!-- Modal -->
<div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModal2Label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModal2Label">添加/修改</h4>
            </div>
            <form method="post" enctype="multipart/form-data">
            <div class="modal-body">
             	<div class="form-group">
	                <label class="" for="position-search">活动结束时间</label>
	                <input type="date" class="form-control" id="endtime-new"   placeholder="活动结束时间">
                </div>
                <div class="form-group" style="margin-right: 10px">
				    <label class="" for="status-new">是否发布:</label>
					<select class="input-small" id="status-new">
						  <option value ="1">是</option>
						  <option value ="0">否</option>
					</select>
				</div>
            	<div class="form-group">
	                <label class="" for="position-search">活动标题</label>
	                <input type="text" class="form-control" id="title-new"   placeholder="活动标题">
                </div>
                <div class="form-group">
	                <label class="" for="position-search">活动简介</label>
	                <input type="text" class="form-control" id="summary-new"  placeholder="活动简介">
                </div>
                <div class="form-group">
	                <label class="" for="position-search">图片</label>
	                <input type="file" id="headerimg-new" accept="image/*" name="file"   style="width:100%">
	               <!--  <a href="javascript:clickfile()" class="btn btn-primary" ></a> -->
                </div>
                <div class="form-group">
	                <p id="img_tobeseen"></p>
                </div>
                <br>
                <div class="form-group">
                	<p id="feedback"></p>
                	<textarea rows="5"  style="width: 100%" placeholder="活动内容" id="content-new" ></textarea>
                </div>
            </div>
            </form>
            <div class="modal-footer">
                <!-- <button type="button" class="btn btn-info" id="initData">添加模拟数据</button> -->
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="save">保存</button>
            </div>
        </div>
    </div>
</div>

 <!-- Modal -->
<div class="modal fade" id="myModal3" tabindex="-1" role="dialog" aria-labelledby="myModal3Label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" >
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModal3Label"><b>上传微信群二维码图片</b></h4>
            </div>
            <div class="modal-body">
            	<div class="form-group">
	                <label class="" for="position-search">选择图片</label>
	                <input type="file" id="wechatgroup-new" accept="image/*" name="file"   style="width:100%">
                </div>
                 <div class="form-group">
	                <p id="wechatgroup_tobeseen"></p>
                </div>
                <br>
            </div>
            <div class="modal-footer">
                <!-- <button type="button" class="btn btn-info" id="initData">添加模拟数据</button> -->
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <!-- <button type="button" class="btn btn-primary" id="save">保存</button> -->
            </div>
        </div>
    </div>
</div>

  
  
  <!-- /.content-wrapper -->
  <footer class="main-footer">
    <div class="pull-right hidden-xs">
      <b>Version</b> 0.0.1
    </div>
    <strong>Copyright &copy; 2016-2019 <a href="http://almsaeedstudio.com">润合美</a>.</strong> All rights reserved.
  </footer>

  <!-- /.control-sidebar -->
  <!-- Add the sidebar's background. This div must be placed
       immediately after the control sidebar -->
  <div class="control-sidebar-bg"></div>
</div>
<!-- ./wrapper -->

<!-- jQuery 2.2.3 -->
<script src="../../plugins/jQuery/jquery-2.2.3.min.js"></script>
<!-- Bootstrap 3.3.6 -->
<script src="../../bootstrap/js/bootstrap.min.js"></script>
<!-- DataTables -->
<script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
<script src="../../plugins/datatables/dataTables.bootstrap.min.js"></script>
<!-- SlimScroll -->
<script src="../../plugins/slimScroll/jquery.slimscroll.min.js"></script>
<!-- FastClick -->
<script src="../../plugins/fastclick/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="../../dist/js/app.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="../../dist/js/demo.js"></script>
<script src="../../dist/js/bootstrap-switch.min.js"></script>
<script src="../../plugins/handlebars-v3.0.1.js"></script>
<script type="text/javascript" src="../../../js/ajaxfileupload.js"></script>
<script src="../../dist/js/common.js"></script>
<script src="../../dist/js/menu.js"></script>
<script type="text/javascript">
var pagename= "activity";
</script>
<!-- page script -->
<!--定义操作列按钮模板-->
<script id="tpl" type="text/x-handlebars-template">
    {{#each func}}
    <button type="button" class="btn btn-{{this.type}} btn-sm" onclick="{{this.fn}}">{{this.name}}</button>
    {{/each}}
</script>

<script>
    var table;
    var detailTable ;
    var detailID ;
    var detailname;
    var detailtaobaocode;
    var imgurlnew = null;
    
    var editFlag = false;
    $(function () {
        //$('#start_date').datetimepicker();
        /**
        *  uploadJson : baseUrl + '/kindeditor/jsp/upload_json.jsp',
		fileManagerJson : baseUrl+ '/kindeditor/jsp/file_manager_json.jsp',
        */
        KindEditor.ready(function(K) {
			window.editor = K.create("#content-new", {
				minWidth : '410px',
				height : '300px',
				resizeType : 0,
				uploadJson : context_path+'jsp/upload_json.jsp',
				fileManagerJson : context_path+'jsp/file_manager_json.jsp',
				allowFileManager : true
			});
		});
        
        var tpl = $("#tpl").html();
        //预编译模板
        var template = Handlebars.compile(tpl);
        
        table = $('#example').DataTable({
            ajax: {
                url: context_path+"admin/activitymanage/activitylist",
                type: "POST",
                data: function(d){
                	  d.content = $('#content-search').val();
                	  d.createdtime = $('#createdtime-search').val();
                	  d.endtime = $('#endtime-search').val();
                	  d.status = $('#status-search').val();
                }
            },
            serverSide: true,
            searching: false ,   //禁用原生搜索
            order: [],          //取消默认排序查询,否则复选框一列会出现小箭头
            columns: [
				{ //复选框单元格
				    className: "td-checkbox",
				    orderable: false,
				    width: "30px",
				    data: null,
				    render: function (data, type, row, meta) {
				        return '<input type="checkbox" value='+row.id+' class="iCheck">';
				    }
				},
				{"data": "id",orderable: false},
                {"data": "title",orderable: false},
                {"data": "headerimg",orderable: false,render:function(data, type, row, meta){
                	
                	return '<img src="'+data+'"  style="height:50px;">';
                }},
                //{"data": "summary",orderable: false},
                {"data": "createdtime",orderable: false,render:function(data, type, row, meta){ 
                	var dt = new Date(data);
                	var date = [
                	            [dt.getFullYear(), dt.getMonth() + 1, dt.getDate()].join('-'),
                	            [dt.getHours(), dt.getMinutes(), dt.getSeconds()].join(':')
                	          ].join(' ').replace(/(?=\b\d\b)/g, '0'); // 正则补零 (略微改动)
                	return date}},
                {"data": "endtime",orderable: false,render:function(data, type, row, meta){ 
                	var dt = new Date(data);
                	var date = [
                	            [dt.getFullYear(), dt.getMonth() + 1, dt.getDate()].join('-')
                	          ].join(' ').replace(/(?=\b\d\b)/g, '0'); // 正则补零 (略微改动)
                	return date}},
                {"data": "statusStr",orderable: false},
                {"data": null,orderable: false}
            ],
            columnDefs: [
                {
                    targets:7,
                    render: function (a, b, c, d) {//data, type, row, meta
                    	var statustmp=c.status;
                    	if(statustmp=="0"){
                    		var context =
                            {
                                func: [
                                    {"name": "详情", "fn": "details(\'"+ c.id + "\')", "type": "primary"}
                                    ,
                                   {"name": "修改", "fn": "modify(\'" + c.id + "\')", "type": "success"}
                                    ,
                                    {"name": "发布", "fn": "switchActivityStatus(\'" + c.id + "\',\'"  +c.status+ "\')", "type": "info"}
                                ]
                            };
                    	}else{
                    		var context =
                            {
                                func: [
                                    {"name": "详情", "fn": "details(\'"+ c.id  + "\')", "type": "primary"}
                                    ,
                                    {"name": "修改", "fn": "modify(\'" + c.id + "\')", "type": "success"}
                                     ,
                                     {"name": "撤回", "fn": "switchActivityStatus(\'" + c.id + "\',\'"  +c.status+ "\')", "type": "danger"}
                                ]
                            };
                    	}
                        var html = template(context);
                        return html;
                    }
                }
            ],
            "language": {
                "lengthMenu": "每页 _MENU_ 条记录",
                "zeroRecords": "没有找到记录",
                "info": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
                "infoEmpty": "无记录",
                "sSearch":  "<b>模糊搜索</b>：",
                "infoFiltered": "(从 _MAX_ 条记录过滤)",
                "paginate": {
                    "previous": "上一页",
                    "next": "下一页"
                },
           		"sEmptyTable":     "没有找到记录",
            	"sLoadingRecords": "载入中..."
            },
            "dom": "<'row'<'col-xs-2'l><'#mytool.col-xs-4'><'col-xs-6'f>r>" + "t" +"<'row'<'col-xs-6'i><'col-xs-6'p>>",
            initComplete: function () {
                //$("#mytool").append('<button id="datainit" type="button" class="btn btn-primary btn-sm">增加基础数据</button>&nbsp');
                $("#mytool").append('<button type="button" id="addButton"          class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModal2" style="margin-right:20px;">添加活动</button>');
                $("#mytool").append('<button type="button" id="wechatGroupButton"  class="btn btn-info btn-sm" data-toggle="modal" data-target="#myModal3">上传微信群二维码图片</button>&nbsp');
                //$("#datainit").on("click", initData);
                $("#addButton").click(function(){
                	/*editFlag=false;
                	$("#myModalLabel").html("新增");
                	$("#id").val("");
                	$("#name").val("");
                    $("#taobaocode").val("");
                    $("#phonenumber").val("");
                    $("#address").val("");
                    $("#groupstatus").val("");
                    $("#status").val("");*/
                });
            }
        });
        $("#save").click(add);
        
        $("#btn-advanced-search").click(function(){
        	table.ajax.reload();
        })
        $("#headerimg-new").change(function(){
        	//console.log(1);
        	if($("#headerimg-new").val()){
    			$.ajaxFileUpload({
    				url :context_path+'admin/activitymanage/uploadheaderimg',
    				secureuri : false,
    				type:"POST",
    				data: {fileName:encodeURI($("#headerimg-new").val())}, 
    				fileElementId : 'headerimg-new',
    				dataType : 'json',
    				success : function(data, status) {
    					//console.log("data:"+data);
    					imgurlnew=data.data;
    					$("#img_tobeseen").html('<img src="'+data.data+'" style="max-width:100%;">');
    					//alert("上传成功");
    				},
    				error : function(data, status, e) {
    					alert("上传异常");
    				}
    			});
    		}
        })
        
        $("#wechatgroup-new").change(function(){
        	if($("#wechatgroup-new").val()){
        		if($("#wechatgroup-new").val()){
        			$.ajaxFileUpload({
        				url :context_path+'admin/activitymanage/uploadgroupImg',
        				secureuri : false,
        				type:"POST",
        				data: {fileName:encodeURI($("#wechatgroup-new").val())}, 
        				fileElementId : 'wechatgroup-new',
        				dataType : 'json',
        				success : function(data, status) {
        					if(data.status == "success"){
        						//console.log("data:"+data);
            					imgurlnew=data.data;
            					$("#wechatgroup_tobeseen").html('<img src="'+data.data+'" style="max-width:100%;">');
            					alert("上传成功");
        					}else{
        						alert("上传异常");
        					}
        				},
        				error : function(data, status, e) {
        					alert("上传异常");
        				}
        			});
        		}
        	}
        })
    });
    /**
     * 清除
     */
    function clear() {
        $("#name").val("").attr("disabled",false);
        $("#position").val("");
        $("#salary").val("");
        $("#start_date").val("");
        $("#office").val("");
        $("#extn").val("");
        editFlag = false;
    }
    
    function switchActivityStatus(id,status){
    	if(status=="0"){
    		var flagstr ="确定要发布吗?";
    		var statusnew ="1";
    	}else{
    		var flagstr ="确定要撤回吗?";
    		var statusnew ="0";
    	}
    	 var flag = confirm(flagstr);
    	 
    	 if(flag){
    		 $.ajax({
    			 type:"POST",
    			 url:context_path+"admin/activitymanage/switchactivitystatus",
    			 data:{id:id,status:statusnew},
    			 success:function(data){
    				 table.ajax.reload(null, false);
    			 }
    		 })
    	 }
    }
    
    
    function clickfile(){
    	console.log(1);
    	$("#headerimg-new").click();
    }
    var modifyID=null;
    /**
     * 
     **/
    function add() {
    	//$("#myModal").modal("hide");
    	if(!$("#endtime-new").val()){
    		alert("活动结束时间不能为空");
    		return false;
    	}
    	if(!$("#title-new").val()){
    		alert("活动标题不能为空");
    		return false;
    	}
    	if(!$("#summary-new").val()){
    		alert("活动简介不能为空");
    		return false;
    	}
    	if(!imgurlnew){
    		alert("活动图片不能为空");
    		return false;
    	}
    	editor.sync();
    	if(!$.trim(editor.html())){
    		alert("活动内容不能为空");
    		return false;
    	}
        var addJson = {
        	id:modifyID,
        	"endtime":$("#endtime-new").val(),
            "title": $("#title-new").val(),
            "summary": $("#summary-new").val(),
            "headerimg":imgurlnew,
            "content":$.trim(editor.html()),
            "status": $("#status-new").val()
        };
        //alert(addJson);
        ajax(addJson);
    }
    function ajax(obj) {
    	console.log(obj);
    	if(modifyID==null){
    		var localurl = context_path+"admin/activitymanage/addactivity";
    	}else{
    		var localurl = context_path+"admin/activitymanage/updateactivity";
    	}
        /*$.post(localurl,obj,function(data){
        	console.log("结果" + data);
        	//$("#myModal2").modal("hide");
        })*/
        $.ajax({
            url:localurl ,
            type:"POST",
            data: obj, 
            success: function (data) {
                table.ajax.reload();
                $("#myModal2").modal("hide");
                $("#endtime-new").val('');
                $("#title-new").val('');
                $("#summary-new").val('');
                imgurlnew=null;
                $("#img_tobeseen").html('');
                editor.html('');
                modifyID=null;
                console.log("结果" + data);
            }
        });
    }
    
    function modify(id){
    	modifyID = id;
		$.ajax({
			type : "POST",
			url : context_path+"admin/activitymanage/activitydetail",
			data : {id : id},
			cache : false,
			dataType : "json",
			success : function(data) {
				var obj = data.data;
				
				editor.html(obj.content);
				  $("#endtime-new").val(porcessDate(obj.endtime.time));
				  $("#title-new").val(obj.title);
				  $("#summary-new").val(obj.summary);
				  imgurlnew=obj.headerimg;
				  $("#img_tobeseen").html('<img src="'+obj.headerimg+'"   style="max-width:100%">');
				  $("#status-new").val(obj.status);
				  
				/*$("#detail-title").html(obj.title);
				$("#detail-summary").html(obj.summary);
				$("#detail-headerimg").html('<img src="' + obj.headerimg+ '" style="max-width:100%" >');
				$("#detail-endtime").html("活动结束日期:" + obj.endtime);
				$("#detail-content").html(obj.content);*/
				//$("#myModal").modal("show");
				$("#myModal2").modal("show");
			}
		})
    	
    	
    	
    	
    	
    	
    }
    /**
     * 积分记录
     **/

	function details(id) {
		modifyID = null;
		detailID = id;
		$.ajax({
			type : "POST",
			url : context_path+"admin/activitymanage/activitydetail",
			data : {id : id},
			cache : false,
			dataType : "json",
			success : function(data) {
				var obj = data.data;
				$("#detail-title").html("<b>活动标题：</b>    "+obj.title);
				$("#detail-summary").html("<b>活动简介：</b>    "+obj.summary);
				$("#detail-headerimg").html('<img src="' + obj.headerimg+ '" style="max-width:100%" >');
				$("#detail-endtime").html("活动结束日期:" + porcessDate(obj.endtime.time));
				$("#detail-content").html(obj.content);
				$("#myModal").modal("show");
			}
		})
	}
    
    function porcessDate(datetimes){
    	var dt = new Date(datetimes);
    	var date = [
    	[dt.getFullYear(), dt.getMonth() + 1, dt.getDate()].join('-')].join('').replace(/(?=\b\d\b)/g, '0'); // 正则补零 (略微改动)
    	return date
    }
</script>
</body>
</html>




